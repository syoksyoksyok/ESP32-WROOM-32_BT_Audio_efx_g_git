; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
; ESP32-WROOM-32 BT Audio Granular Processor - PlatformIO Configuration
; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
;
; 3つのビルド環境を提供:
;   - debug   : 開発・デバッグ用（最大限のデバッグ情報）
;   - test    : 性能テスト用（バランス型最適化+プロファイリング）
;   - release : 本番用（最大パフォーマンス、ログなし）
;
; 使用方法:
;   pio run -e debug      # デバッグビルド
;   pio run -e test       # テストビルド
;   pio run -e release    # リリースビルド
;   pio run -e release -t upload  # リリース版をアップロード
;
; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

; ================================================================
; 共通設定（全環境で共有）
; ================================================================
[env]
platform = espressif32
board = esp32dev
framework = arduino

; Serial Monitor
monitor_speed = 115200

; Library dependencies
lib_deps =
    https://github.com/pschatzmann/ESP32-A2DP.git
    bodmer/TFT_eSPI@^2.5.43

; Upload settings
upload_speed = 921600

; Partition scheme for larger app size
board_build.partitions = huge_app.csv

; Hardware configuration
board_build.f_cpu = 240000000L
board_build.f_flash = 80000000L
board_build.flash_mode = qio

; ================================================================
; [debug] デバッグ環境
; ================================================================
; 目的: 開発・デバッグ作業
; 最適化: -Og（デバッグ優先、変数最適化最小）
; ログ: VERBOSE（詳細ログ出力）
; 特徴: 完全なスタックトレース、例外デコード対応
; ================================================================
[env:debug]
build_type = debug
monitor_filters = esp32_exception_decoder

build_flags =
    ; デバッグレベル（最大）
    -DCORE_DEBUG_LEVEL=5

    ; 最適化レベル（デバッグ優先）
    -Og
    -g3

    ; ハードウェア設定
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue

    ; TFT_eSPI設定
    -DUSER_SETUP_LOADED=1
    -I include

    ; プロファイリング無効
    -UPROFILE_ENABLED

build_unflags =
    -Os

; ================================================================
; [test] テスト環境
; ================================================================
; 目的: 性能テスト・チューニング
; 最適化: -O2（バランス型）
; ログ: INFO（重要な情報のみ）
; 特徴: プロファイリング有効、性能測定可能
; ================================================================
[env:test]
build_type = debug
monitor_filters = esp32_exception_decoder

build_flags =
    ; デバッグレベル（中程度）
    -DCORE_DEBUG_LEVEL=3

    ; 最適化レベル（バランス型）
    -O2
    -g

    ; ハードウェア設定
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue

    ; TFT_eSPI設定
    -DUSER_SETUP_LOADED=1
    -I include

    ; プロファイリング有効
    -DPROFILE_ENABLED=1

    ; 基本的な最適化
    -funroll-loops
    -finline-functions

build_unflags =
    -Os

; ================================================================
; [release] リリース環境（本番用）
; ================================================================
; 目的: 本番運用・最大パフォーマンス
; 最適化: -O3（最大）+ 高度な最適化フラグ
; ログ: なし（CORE_DEBUG_LEVEL=0）
; 予想性能: CPU使用率 85% → 55%、レイテンシ 12ms → 8ms
; ================================================================
[env:release]
build_type = release

build_flags =
    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; デバッグ設定
    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; ログ完全無効（パフォーマンス優先）
    -DCORE_DEBUG_LEVEL=0

    ; プロファイリング無効
    -UPROFILE_ENABLED

    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; 最適化レベル
    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; 最大最適化
    -O3

    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; 浮動小数点最適化
    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; 高速浮動小数点演算（精度トレードオフ許容）
    ; ピッチ計算、ウィンドウ関数などで効果大
    -ffast-math

    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; ループ最適化
    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; ループ展開（グレイン処理、LUT初期化で効果大）
    -funroll-loops

    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; 関数最適化
    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; 積極的インライン化（関数呼び出しオーバーヘッド削減）
    -finline-functions
    -finline-limit=1000

    ; フレームポインタ省略（レジスタ活用増加）
    -fomit-frame-pointer

    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; C++機能の無効化（組み込み向け）
    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; 例外処理なし（コードサイズ削減、速度向上）
    -fno-exceptions

    ; RTTI（実行時型情報）不要
    -fno-rtti

    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; コードサイズ最適化
    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; 関数・データセクション分割（未使用コード削除用）
    -ffunction-sections
    -fdata-sections

    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; リンカ最適化
    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; 未使用セクション削除（コードサイズ削減）
    -Wl,--gc-sections

    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; ESP32固有設定
    ; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ; PSRAM対応
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue

    ; TFT_eSPI設定
    -DUSER_SETUP_LOADED=1
    -I include

build_unflags =
    ; デフォルトの -Os を削除（-O3 を優先）
    -Os
    ; デフォルトの最適化フラグを削除
    -O2
    -Og

; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
; 環境別の使い分けガイド
; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
;
; [debug]   : 開発中、バグ修正時、クラッシュ解析時
; [test]    : 性能チューニング、ベンチマーク測定時
; [release] : 本番デプロイ、最終製品、パフォーマンス重視時
;
; ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
